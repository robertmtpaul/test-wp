'use strict';(function(v){const w=function(a,c){this.$table=v(a);this.top=window.top.document;this.init(c)};w.prototype={$table:null,app:null,init:function(a){this.app=a;this.loadExtraFields(a.values);this.makeSortable();this.events()},loadOrders:function(a,c){let d;try{d=JSON.parse(a.field_order)}catch(n){}d||(d={});a=this.$table[0].getElementsByTagName("tbody")[0];const b=a.getElementsByTagName("tr"),g=[],e=document.createDocumentFragment();let m;for(let a=0,c=b.length;a<c;++a)b[a].classList.contains("tb_no_sort")?
m=b[a]:g.push(b[a]);g.sort(function(a,b){let f;let e=a.classList.contains("tb_contact_new_row");var g=b.classList.contains("tb_contact_new_row");let n=function(a){for(let b=c.length-1;-1<b;--b)if((c[b].label===a||c[b].id===a)&&void 0!==c[b].order)return c[b].order;return!1};f=e?a.getElementsByClassName("tb_new_field_textbox")[0].value:a.getElementsByClassName("tb_lb_option")[0].id;f=e&&""===f?a.getElementsByClassName("tb_new_field_textbox")[0].dataset.id:f;b=g?b.getElementsByClassName("tb_new_field_textbox")[0].value:
b.getElementsByClassName("tb_lb_option")[0].id;b=g&&""===b?a.getElementsByClassName("tb_new_field_textbox")[0].dataset.id:b;f=f.trim();b=b.trim();a=void 0!==d[f]?d[f]:e?n(f):!1;g=void 0!==d[b]?d[b]:g?n(b):!1;return a-g});for(let a=0,c=g.length;a<c;++a)e.appendChild(g[a]);for(e.appendChild(m);a.firstChild;)a.removeChild(a.firstChild);a.appendChild(e)},loadExtraFields:function(a){let c,d=this.$table[0].getElementsByClassName("tb_no_sort")[0];try{c=JSON.parse(a.field_extra).fields}catch(g){}c||(c={fields:[]});
const b=document.createDocumentFragment();for(let a=0,d=c.length;a<d;++a)b.appendChild(this.addField(c[a]));d.parentNode.insertBefore(b,d);this.loadOrders(a,c)},events:function(){const a=this;this.$table.on("click.tb_contact",".tb_new_field_action",function(c){c.preventDefault();c.stopPropagation();c=this.closest(".tb_no_sort");c.parentNode.insertBefore(a.addField({}),c);a.$table.find("tbody").sortable("refresh");a.changeObject()}).on("change.tb_contact",".tb_new_field_type",function(){a.switchField(this);
a.changeObject()}).on("click.tb_contact",".tb_add_field_option",function(c){c.preventDefault();c.stopPropagation();this.previousElementSibling.appendChild(a.render.getOptions([""]))}).on("keyup.tb_contact",'.tb_contact_new_row input[type="text"], .tb_contact_new_row textarea',function(){a.changeObject()}).on("change.tb_contact",".tb_contact_new_row .tb_new_field_required",function(){a.changeObject()}).on("click.tb_contact",".tb_contact_value_remove,.tb_contact_field_remove",function(c){c.preventDefault();
c.stopPropagation();this.classList.contains("tb_contact_value_remove")?v(this).closest("li").remove():v(this).closest(".tb_contact_new_row").remove();a.changeObject()})},makeSortable:function(){const a=this;this.$table.find("tbody").sortable({items:"tr:not(.tb_no_sort)",placeholder:"ui-state-highlight",axis:"y",containment:"parent",update:function(){a.changeObject()}})},render:{call:function(a,c){return void 0===this[c]?this._default(a,c):this[c].call(this,a,c)},setType:function(a,c){a.setAttribute("data-type",
c)},getText:function(a,c,d){const b=document.createElement(d);"textarea"!==d&&(b.type="tel"!==d?"text":"tel");a.value&&(b.value=a.value.replace(/&quot;/g,'"'));b.className="tb_new_field_value tb_field_type_text";this.setType(b,c);return b},static:function(a,c){a=this._default(a,"textarea");a.placeholder=tb_contact_l10n.static_text;this.setType(a,"static");return a},upload:function(a,c){return document.createElement("div")},getOptions:function(a){const c=document.createDocumentFragment();for(let d in a){let b=
document.createElement("li"),g=document.createElement("a"),e=document.createElement("input");e.type="text";e.className="tb_multi_option";e.value=a[d];g.className="tb_contact_value_remove tf_close";g.href="#";b.appendChild(e);b.appendChild(g);c.appendChild(b)}return c},_default:function(a,c){if("text"===c||"textarea"===c||"tel"===c)return this.getText(a,c,"textarea"===c?c:"input");const d=document.createElement("ul"),b=document.createElement("a"),g=document.createDocumentFragment();d.appendChild(this.getOptions(a.value||
[""]));g.appendChild(d);b.href="#";b.className="tb_add_field_option";b.textContent=tb_contact_l10n.add_option;this.setType(b,c);g.appendChild(b);return g}},addField:function(a){var c=0===Object.keys(a).length;const d=a.type?a.type:"text",b=document.createElement("tr"),g=document.createElement("td"),e=document.createElement("input"),m=document.createElement("td"),n=document.createElement("div"),u=document.createElement("select"),f=document.createDocumentFragment(),t=document.createElement("div"),q=
document.createElement("div"),p=document.createElement("label"),l=document.createElement("input"),k=document.createElement("a"),h=tb_contact_l10n.types,r="tb_"+tb_app.Utils.generateUniqueID();t.className="control-input";q.className="tb_new_field";n.className="selectwrapper";u.className="tb_new_field_type tb_lb_option";b.className="tb_contact_new_row";e.type="text";e.className="tb_new_field_textbox";e.value=void 0===a.label?!0===c?tb_contact_l10n.field_name:"":a.label;e.dataset.id=void 0===a.id?"":
a.id;l.type="checkbox";l.className="tb_new_field_required";l.value="required";"static"===d&&(p.style.display="none");!0===a.required&&(l.checked=!0);k.className="tb_contact_field_remove tf_close";k.href="#";m.setAttribute("colspan","3");g.appendChild(e);b.appendChild(g);for(let a in h)c=document.createElement("option"),c.name=r,a===d&&(c.selected="selected"),c.value=a,c.textContent=h[a],f.appendChild(c);u.appendChild(f);n.appendChild(u);m.appendChild(n);t.appendChild(this.render.call(a,d));q.appendChild(t);
p.appendChild(l);p.appendChild(document.createTextNode(tb_contact_l10n.req));q.appendChild(p);m.appendChild(q);m.appendChild(k);b.appendChild(m);return b},switchField:function(a){const c=a.value;a=a.closest("td").getElementsByClassName("control-input")[0];const d=a.closest(".tb_new_field").getElementsByClassName("tb_new_field_required")[0].parentNode;for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(this.render.call({},c));d.style.display="static"===c?"none":""},changeObject:function(){var a=
this.$table[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),c={fields:[]};const d={};for(let e=0,m=a.length;e<m;++e)if(a[e].classList.contains("tb_contact_new_row")){var b=a[e].getElementsByClassName("tb_new_field_type")[0].options[a[e].getElementsByClassName("tb_new_field_type")[0].selectedIndex].value;let d=a[e].getElementsByClassName("tb_new_field_textbox")[0].value.trim(),m="static"!==b&&!0===a[e].getElementsByClassName("tb_new_field_required")[0].checked,f;switch(b){case "text":case "textarea":case "static":case "tel":f=
a[e].getElementsByClassName("tb_new_field_value")[0].value.trim();break;case "radio":case "select":case "checkbox":f=[];var g=a[e].getElementsByClassName("control-input")[0].getElementsByTagName("input");for(let a=0,c=g.length;a<c;++a){let c=g[a].value.trim();""!==c&&f.push(c)}}if(""!==f&&void 0!==f||""!==d){g={type:b,order:e};m&&(g.required=m);""!==d?g.label=d:g.id="ex"+e;if(void 0!==f&&""!==f&&0<f.length){if("static"===b)f=f.replace(/"/g,'\\\\"');else if("text"===b||"textarea"===b)f=f.replace(/"/g,
"&quot;");if("static"===b||"textarea"===b)f=f.replace(/\n/g,"\\\\n");g.value=f}c.fields.push(g)}}else a[e].classList.contains("tb_no_sort")||(b=a[e].getElementsByClassName("tb_lb_option")[0].id,d[b]=e);a=this.top.getElementById("field_extra");a.value=JSON.stringify(c);c=JSON.stringify(d);this.top.getElementById("field_order").value=c;this.app.settings.field_order=c;Themify.triggerEvent(a,"change")}};let x=null;tb_app.Constructor.contact_fields={render:function(a,c){var d=window.top;null===x&&(x=!0,
d.Themify.LoadCss(tb_contact_l10n.admin_css,tb_contact_l10n.v));d=document.createElement("tr");const b=document.createElement("table"),g=document.createElement("thead"),e=document.createElement("tbody"),m=document.createElement("tfoot"),n=document.createDocumentFragment(),u=a.options.head;var f=a.options.body;const t=a.options.foot,q={text:function(a,b,d){a={id:"field_"+a,placeholder:b,"class":"large",type:"text"};d&&(a.help=d);return c.create([a])},checkbox:function(a){const b={id:"field_"+a,new_line:!0,
type:"checkbox",options:[{value:"",name:"yes"}]};"sendcopy_active"===a&&(b.binding={checked:{show:["field_sendcopy_subject"]},not_checked:{hide:["field_sendcopy_subject"]}});"optin_active"===a&&(b.binding={checked:{show:["optin"]},not_checked:{hide:["optin"]}});return c.create([b])}};for(var p in u){var l=document.createElement("th");"l"===p&&(l.colSpan=2);l.textContent=u[p];d.appendChild(l)}g.appendChild(d);for(var k in f){d=document.createElement("tr");for(var h in u){p=document.createElement("td");
l=null;if("f"===h)l=document.createElement("span"),p.textContent=f[k];else if("l"===h){if(p.colSpan="2",l=q.text(k+"_label",f[k]),l.appendChild(q.text(k+"_placeholder",tb_contact_l10n.pl)),"message"!==k){var r=document.createDocumentFragment(),v=q.checkbox(k+"_require");r.appendChild(l);v.querySelector(".tb_lb_option").appendChild(document.createTextNode(tb_contact_l10n.req));r.appendChild(v);l=r}}else"sh"===h&&(l=q.checkbox(k+"_active"));null!==l&&p.appendChild(l);d.appendChild(p)}n.appendChild(d)}d=
document.createElement("tr");k=document.createElement("td");h=document.createElement("a");f=document.createElement("span");h.className="tb_new_field_action";h.href="#";f.className="tf_plus_icon";h.appendChild(f);h.appendChild(document.createTextNode(a.new_row));k.setAttribute("colspan","4");k.appendChild(h);d.className="tb_no_sort";d.appendChild(k);n.appendChild(d);e.appendChild(n);for(let b in t)if("align"!==b){d=document.createElement("tr");for(let e in u)if("sh"!==e||"send"!==b)a=document.createElement("td"),
h=null,"f"===e?a.textContent=t[b]:"l"===e?(a.colSpan=2,k=q.text(b+"_label",t[b]),"send"===b?(a.colSpan=3,r=document.createDocumentFragment(),h=c.select.render({id:t.align.id,options:t.align.options},c),r.appendChild(k),r.appendChild(h),r.appendChild(document.createTextNode(t.align.label)),h=r):"optin"===b?(h=document.createDocumentFragment(),f=ThemifyConstructor.create([{type:"optin_provider",id:"optin"}]),h.appendChild(k),h.appendChild(f)):h=k,r.appendChild(v)):"sh"===e&&"send"!==b&&(h=q.checkbox(b+
"_active"),"captcha"===b&&""!==tb_contact_l10n.captcha&&h.querySelector("input").addEventListener("change",function(a){a=this.closest("td").previousElementSibling;if(!0===this.checked){const b=document.createElement("div");b.className="tb_captcha_message tb_field_error_msg";b.innerHTML=tb_contact_l10n.captcha;a.appendChild(b)}else a=a.getElementsByClassName("tb_captcha_message")[0],"undefined"!==typeof a&&a.parentNode.removeChild(a)},{passive:!0})),null!==h&&a.appendChild(h),"l"===e&&"sendcopy"===
b&&a.appendChild(c.create([{id:"field_"+b+"_subject",after:tb_contact_l10n.sendcopy_sub,type:"text","class":"small"}])),d.appendChild(a);n.appendChild(d)}m.appendChild(n);b.className="contact_fields";b.appendChild(g);b.appendChild(e);b.appendChild(m);document.addEventListener("tb_editing_contact",function(a){const d=new w(b,c);Themify.body.one("themify_builder_lightbox_close",function(a){d.$table.off("click.tb_contact keyup.tb_contact change.tb_contact")})},{once:!0});return b}}})(jQuery);
